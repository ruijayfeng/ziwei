# 紫微斗数 App 设计方案

> 日期：2026-01-04
> 状态：已确认，待开发

---

## 一、产品定位

**一句话描述：**
> 开源的紫微斗数命盘工具，精准排盘 + AI 深度解读，支持自部署和多模型切换。

**目标用户：**
- 对命理好奇的普通人（圈外人）
- 想自部署的开发者 / 技术爱好者
- 国内外中文用户

**核心卖点：**
1. **专业准确** — 排盘算法严谨，真太阳时校正
2. **AI 加持** — 不只是冷冰冰的命盘，有深度解读
3. **开源免费** — 可自部署，用自己的 API Key
4. **设计精良** — 不是土味命理网站，现代审美

**商业模式：**
- 完全开源免费
- 用户可自部署或使用自己的 API Key
- 先跑用户量，后期再考虑变现

---

## 二、功能架构

```
┌─────────────────────────────────────────────────┐
│                   紫微斗数 App                    │
├─────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐   │
│  │  命盘排盘  │  │  AI 解读  │  │  年度运势  │   │
│  └───────────┘  └───────────┘  └───────────┘   │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐   │
│  │  双人合盘  │  │  分享卡片  │  │  设置中心  │   │
│  └───────────┘  └───────────┘  └───────────┘   │
├─────────────────────────────────────────────────┤
│  排盘引擎 (iztro)  │  多模型适配层  │  卡片生成   │
└─────────────────────────────────────────────────┘
```

**六大功能：**

| 功能 | 说明 |
|------|------|
| **命盘排盘** | 输入生辰 → 生成完整命盘，支持真太阳时校正 |
| **AI 解读** | 基于命盘 JSON + 知识库，生成个性化解读 |
| **年度运势** | 流年运势分析，可选具体年份 |
| **双人合盘** | 两人命盘对比，分析契合度 |
| **分享卡片** | 生成精美图片，可保存/分享 |
| **设置中心** | API Key 配置、模型选择、主题切换 |

---

## 三、用户输入

| 字段 | 必填？ | 说明 |
|------|--------|------|
| 出生日期 | ✅ | 年月日 |
| 出生时间 | ✅ | 精确到小时，系统归入时辰 |
| 性别 | ✅ | 大限行运方向 |
| 出生地 | ⚪ 可选 | 真太阳时校正（西部地区建议填写） |
| 关注方向 | ⚪ 可选 | AI 深度解读用（事业/感情/财运等） |

---

## 四、技术栈

**前端：**

| 选择 | 方案 | 理由 |
|------|------|------|
| 框架 | React + TypeScript | 生态成熟，iztro 库原生支持 |
| 构建 | Vite | 快，开发体验好 |
| 样式 | Tailwind CSS | 原子化，配合设计系统高效 |
| UI组件 | shadcn/ui | 可定制，不臃肿，Apple 质感 |
| 状态管理 | Zustand | 轻量，够用 |
| 本地存储 | Dexie.js（IndexedDB封装） | 命盘历史存储 |

**核心依赖：**

| 库 | 用途 |
|------|------|
| iztro | 紫微斗数排盘引擎 |
| html-to-image | 分享卡片生成 |
| date-fns | 日期处理 |
| lunar-javascript | 农历转换（备选） |

**部署：**
- Vercel / Netlify / Cloudflare Pages
- 纯静态部署，零后端成本

---

## 五、数据存储

**纯前端存储方案：**

```
┌─────────────────────────────────────┐
│           浏览器本地存储             │
├─────────────────────────────────────┤
│  API Key      → localStorage (加密) │
│  用户设置     → localStorage        │
│  命盘历史     → IndexedDB           │
│  分享卡片缓存  → IndexedDB          │
└─────────────────────────────────────┘
```

---

## 六、AI 解读设计

### 多模型支持

| 模型 | 特点 | API格式 |
|------|------|---------|
| Kimi | 国内直连，中文强 | 兼容 OpenAI 格式 |
| Gemini | 免费额度大 | Google AI 格式 |
| Claude | 解读质量高 | Anthropic 格式 |
| DeepSeek | 便宜，中文好 | 兼容 OpenAI 格式 |
| 自定义 | 兼容 OpenAI 格式的都行 | OpenAI 格式 |

### 知识检索：混合模式

```
┌─────────────────────────────────────────────────────┐
│                    知识检索层                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│   【离线层】               【联网层】（可选）        │
│   ┌───────────┐           ┌───────────────┐        │
│   │ 核心知识库 │           │ 搜索 API 检索  │        │
│   │ (打包在项目)│          │ (Tavily/Serper)│        │
│   └───────────┘           └───────────────┘        │
│        ↓                         ↓                 │
│   基础解读保证              深度内容补充            │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 结构化知识库

```
knowledge/
├── stars/          # 十四主星 + 辅星详解
├── palaces/        # 十二宫位详解
├── patterns/       # 格局判断
├── sihua/          # 四化详解
└── limits/         # 运限规则
```

### 检索逻辑

```
命盘数据分析
    ↓
1. 提取命宫主星 → 检索对应星曜详解
2. 提取各宫星曜 → 检索星曜+宫位组合解读
3. 识别格局 → 检索格局详解
4. 提取四化 → 检索四化+宫位含义
5. 当前流年 → 检索流年相关规则
    ↓
组装完整 Context
    ↓
System Prompt + 知识 Context + 命盘数据
    ↓
LLM 深度解读
```

### 解读模块

| 模块 | 内容 |
|------|------|
| 总览 | 命格概述，一句话定调 |
| 性格 | 命宫主星解读 |
| 事业 | 官禄宫 + 四化 |
| 财运 | 财帛宫 + 武曲/太阴等 |
| 感情 | 夫妻宫 + 桃花星 |
| 健康 | 疾厄宫提醒 |
| 流年 | 结合当前年份的运势 |

---

## 七、页面结构

```
首页 (/)
├── 命盘页 (/chart)
│   ├── 命盘可视化
│   ├── AI 解读面板
│   └── 操作栏（分享/保存/查运势）
├── 年度运势 (/fortune)
│   └── 选择年份 → 流年分析
├── 双人合盘 (/match)
│   └── 输入两人信息 → 契合度分析
├── 历史记录 (/history)
│   └── 本地存储的命盘列表
└── 设置 (/settings)
    ├── API Key 配置
    ├── 模型选择
    └── 主题/语言
```

**核心流程：**

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  首页   │ →  │ 输入生辰 │ →  │ 命盘展示 │ →  │ AI解读  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                                   ↓
                    ┌──────────────┼──────────────┐
                    ↓              ↓              ↓
              ┌─────────┐   ┌─────────┐    ┌─────────┐
              │年度运势  │   │双人合盘  │    │分享卡片  │
              └─────────┘   └─────────┘    └─────────┘
```

---

## 八、视觉设计

### 设计原则

**追求：**
- ✅ 克制、留白、呼吸感
- ✅ 色彩用得少但用得准
- ✅ 质感真实，温暖不冷冰

**避免：**
- ❌ 廉价感（字体乱、配色脏、元素挤）
- ❌ AI蓝紫渐变（僵硬的 Midjourney 感）
- ❌ 土味命理风

### 色彩系统

```
主色调：
- 深靛蓝 #1a1b3a    ← 背景/夜空感
- 星光紫 #6366f1    ← 主要强调色
- 暖琥珀 #f59e0b    ← 温暖点缀
- 月白色 #f8fafc    ← 文字/卡片

语义色：
- 吉 → 暖金 #fbbf24
- 凶 → 柔红 #f87171（不刺眼）
- 中性 → 银灰 #94a3b8
```

### 质感

```css
/* 毛玻璃卡片 */
.card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
}

/* 微光边缘 */
.glow {
  box-shadow: 0 0 20px rgba(99, 102, 241, 0.15);
}
```

### 插画元素

| 元素 | 设计方向 |
|------|----------|
| 十四主星 | 设计成「星灵图标」— 简洁但有辨识度 |
| 十二宫 | 扁平图标 + 微动效 |
| 背景 | 深色渐变 + 缓慢飘动的星点 |
| 空状态 | 温暖的插画引导 |

---

## 九、项目结构

```
ziwei/
├── public/
│   └── assets/           # 静态资源（图标、插画）
├── src/
│   ├── components/       # UI 组件
│   │   ├── ui/          # 基础组件 (shadcn)
│   │   ├── chart/       # 命盘相关组件
│   │   ├── fortune/     # 运势相关组件
│   │   └── share/       # 分享卡片组件
│   ├── lib/
│   │   ├── iztro/       # 排盘引擎封装
│   │   ├── knowledge/   # 知识库检索
│   │   ├── llm/         # 多模型适配层
│   │   └── utils/       # 工具函数
│   ├── knowledge/        # 知识库 JSON
│   ├── stores/          # Zustand 状态
│   ├── pages/           # 页面组件
│   └── styles/          # 全局样式
├── scripts/
│   └── crawl/           # 知识库预处理脚本
└── docs/
    └── plans/           # 设计文档
```

---

## 十、开发计划

| 阶段 | 内容 | 交付物 |
|------|------|--------|
| **P1** | 核心排盘 + 基础UI | 能生成命盘并展示 |
| **P2** | AI 解读 + 知识库 | 多模型接入，结构化检索 |
| **P3** | 年度运势 + 双人合盘 | 完整功能 |
| **P4** | 分享卡片 + 打磨 | 可发布版本 |

---

## 十一、待定事项

- [ ] 项目名称
- [ ] 具体图标/插画素材（开发阶段提供需求清单）
- [ ] 知识库预处理脚本开发
- [ ] 联网搜索 API 选型确认

---

## 附录：参考风格

- **Co-Star**（星座App）— 神秘 + 现代
- **Headspace**（冥想App）— 温暖插画 + 高级感
- **Apple天气App** — 毛玻璃 + 渐变背景
