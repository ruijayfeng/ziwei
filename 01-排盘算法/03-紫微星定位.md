# 紫微星定位算法

## 核心口诀

> **生日除局商为月，一自寅起紫微定**
> **只加不减到整除，阳退阴进记心中**

（阳退 = 奇数后退，阴进 = 偶数前进）

---

## 一、算法原理

### 基本公式

```
紫微星位置 = f(出生日, 五行局数)
```

### 计算步骤

```
Step 1: 出生日 ÷ 五行局数 = 商 ... 余数
Step 2:
    - 若能整除（余数=0）：商数即为宫位序号
    - 若不能整除：加最小数使其整除，根据加数奇偶调整位置
Step 3: 商数对应宫位（寅=1, 卯=2, ..., 丑=12）
Step 4: 若商数 > 12，则减去12
```

### 余数处理规则

当不能整除时：

| 情况 | 处理方法 |
|------|---------|
| 余数存在 | 加最小数使其整除 |
| 加数为奇数 | 从商数位置**后退**（逆时针） |
| 加数为偶数 | 从商数位置**前进**（顺时针） |

---

## 二、详细算法

### 代码实现

```python
DIZHI_ORDER = ['寅','卯','辰','巳','午','未','申','酉','戌','亥','子','丑']

def get_ziwei_position(birth_day, ju_num):
    """
    计算紫微星位置
    birth_day: 出生日（农历）1-30
    ju_num: 五行局数（2,3,4,5,6）
    返回: 紫微星所在地支
    """
    quotient = birth_day // ju_num
    remainder = birth_day % ju_num

    if remainder == 0:
        # 能整除，直接取商
        position = quotient
    else:
        # 不能整除，计算需要加的数
        add_num = ju_num - remainder
        new_quotient = (birth_day + add_num) // ju_num

        if add_num % 2 == 1:  # 奇数，后退
            position = new_quotient - add_num
        else:  # 偶数，前进
            position = new_quotient + add_num

    # 处理位置超出范围
    while position > 12:
        position -= 12
    while position < 1:
        position += 12

    return DIZHI_ORDER[position - 1]
```

---

## 三、计算实例

### 例1：能整除的情况

**水二局，28日生**
```
28 ÷ 2 = 14 ... 0（整除）
14 > 12, 14 - 12 = 2
位置 = 2 → 卯宫
紫微星在卯宫
```

### 例2：不能整除，加奇数

**土五局，14日生**
```
14 ÷ 5 = 2 ... 4（余4）
需加 5 - 4 = 1（奇数）
(14 + 1) ÷ 5 = 3
加数1为奇数，后退1位
位置 = 3 - 1 = 2 → 卯宫
紫微星在卯宫
```

### 例3：不能整除，加偶数

**木三局，22日生**
```
22 ÷ 3 = 7 ... 1（余1）
需加 3 - 1 = 2（偶数）
(22 + 2) ÷ 3 = 8
加数2为偶数，前进2位
位置 = 8 + 2 = 10 → 亥宫
紫微星在亥宫
```

### 例4：金四局，27日生

```
27 ÷ 4 = 6 ... 3（余3）
需加 4 - 3 = 1（奇数）
(27 + 1) ÷ 4 = 7
加数1为奇数，后退1位
位置 = 7 - 1 = 6 → 未宫
紫微星在未宫
```

---

## 四、紫微星位置速查表

### 水二局（局数=2）

| 出生日 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|
| 紫微宫 | 寅 | 寅 | 卯 | 卯 | 辰 | 辰 | 巳 | 巳 | 午 | 午 | 未 | 未 | 申 | 申 | 酉 |

| 出生日 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 30 |
|--------|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|
| 紫微宫 | 酉 | 戌 | 戌 | 亥 | 亥 | 子 | 子 | 丑 | 丑 | 寅 | 寅 | 卯 | 卯 | 辰 | 辰 |

### 完整速查表生成

```python
def generate_ziwei_table():
    """生成所有五行局的紫微星位置速查表"""
    ju_list = [2, 3, 4, 5, 6]
    table = {}
    for ju in ju_list:
        table[ju] = {}
        for day in range(1, 31):
            table[ju][day] = get_ziwei_position(day, ju)
    return table
```

---

## 五、天府星定位

### 紫府对称规则

紫微星与天府星以**寅申宫连线**为轴对称。

```
紫微位置 + 天府位置 = 14（以寅=1计算）
```

### 公式

```python
def get_tianfu_position(ziwei_idx):
    """
    ziwei_idx: 紫微星位置索引（寅=1, 卯=2, ..., 丑=12）
    返回: 天府星位置索引
    """
    tianfu_idx = 14 - ziwei_idx
    if tianfu_idx > 12:
        tianfu_idx -= 12
    return tianfu_idx
```

### 紫府对照表

| 紫微 | 寅 | 卯 | 辰 | 巳 | 午 | 未 | 申 | 酉 | 戌 | 亥 | 子 | 丑 |
|------|----|----|----|----|----|----|----|----|----|----|----|----|
| 天府 | 丑 | 子 | 亥 | 戌 | 酉 | 申 | 未 | 午 | 巳 | 辰 | 卯 | 寅 |

**特殊情况**：寅申二宫紫府同宫

---

## 参考资源

- [紫微斗数如何定五行局和紫微星 - 知乎](https://zhuanlan.zhihu.com/p/669148811)
- [紫微斗数算法的实现流程 - CSDN](https://blog.csdn.net/daowzq/article/details/141968514)
- [紫微斗数14主星排盘 - 知乎](https://zhuanlan.zhihu.com/p/1888999711618363879)
