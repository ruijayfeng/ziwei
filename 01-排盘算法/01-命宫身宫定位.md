# 命宫身宫定位算法

## 核心口诀

> **斗柄建寅起正月，数至生月顺流行，子时起数生时止，逆回安命顺安身**

## 一、命宫定位

### 算法步骤

```
Step 1: 从寅宫起正月，顺时针数至出生月
Step 2: 从该宫起子时，逆时针数至出生时辰
Step 3: 所到之宫即为命宫
```

### 地支宫位排列（顺时针）

```
        巳  午  未  申
        ┌──┬──┬──┬──┐
        │4 │5 │6 │7 │
    辰  ├──┼──┼──┼──┤ 酉
        │3 │        │8 │
    卯  ├──┤  命盘  ├──┤ 戌
        │2 │        │9 │
    寅  ├──┼──┼──┼──┤ 亥
        │1 │12│11│10│
        └──┴──┴──┴──┘
        丑  子  亥  戌

寅=1, 卯=2, 辰=3, 巳=4, 午=5, 未=6
申=7, 酉=8, 戌=9, 亥=10, 子=11, 丑=12
```

### 计算公式

```python
# 命宫地支索引计算
# month: 农历月份 (1-12)
# hour: 时辰索引 (子=0, 丑=1, ..., 亥=11)

def get_ming_gong(month, hour):
    # 寅宫索引为0，数组按寅卯辰巳午未申酉戌亥子丑排列
    # 公式: (14 + month - hour) % 12
    idx = (14 + month - hour) % 12
    return DIZHI[idx]  # DIZHI = ['寅','卯','辰','巳','午','未','申','酉','戌','亥','子','丑']
```

### 计算实例

**例1：农历五月寅时生人**
```
Step 1: 寅→正月, 卯→二月, 辰→三月, 巳→四月, 午→五月
Step 2: 午宫起子时，逆数: 午→子, 巳→丑, 辰→寅
Step 3: 命宫 = 辰宫
```

**例2：农历三月辰时生人**
```
Step 1: 寅→正月, 卯→二月, 辰→三月
Step 2: 辰宫起子时，逆数: 辰→子, 卯→丑, 寅→寅, 丑→卯, 子→辰
Step 3: 命宫 = 子宫
```

**例3：农历二月午时生人**
```
Step 1: 寅→正月, 卯→二月
Step 2: 卯宫起子时，逆数: 卯→子, 寅→丑, 丑→寅, 子→卯, 亥→辰, 戌→巳, 酉→午
Step 3: 命宫 = 酉宫
```

---

## 二、身宫定位

### 算法步骤

```
Step 1: 从寅宫起正月，顺时针数至出生月（同命宫）
Step 2: 从该宫起子时，顺时针数至出生时辰（与命宫相反）
Step 3: 所到之宫即为身宫
```

### 计算公式

```python
def get_shen_gong(month, hour):
    # 身宫公式: (month + hour) % 12
    idx = (month + hour) % 12
    return DIZHI[idx]
```

### 计算实例

**例1：农历五月寅时生人**
```
Step 1: 寅→正月, 卯→二月, 辰→三月, 巳→四月, 午→五月
Step 2: 午宫起子时，顺数: 午→子, 未→丑, 申→寅
Step 3: 身宫 = 申宫
```

### 命宫与身宫的区别

| 项目 | 命宫 | 身宫 |
|------|------|------|
| 第二步方向 | 逆时针 | 顺时针 |
| 代表意义 | 先天命格、本性 | 后天追求、执着方向 |
| 重要性 | 最核心宫位 | 成年后影响加大 |

---

## 三、十二宫排布

命宫确定后，按**逆时针**方向依次排布其余十一宫：

```
命宫 → 兄弟 → 夫妻 → 子女 → 财帛 → 疾厄 →
迁移 → 交友(奴仆) → 官禄(事业) → 田宅 → 福德 → 父母
```

### 代码实现

```python
TWELVE_PALACES = [
    '命宫', '兄弟', '夫妻', '子女', '财帛', '疾厄',
    '迁移', '交友', '官禄', '田宅', '福德', '父母'
]

def arrange_palaces(ming_gong_idx):
    """从命宫开始逆时针排布十二宫"""
    palaces = {}
    for i, palace_name in enumerate(TWELVE_PALACES):
        # 逆时针 = 索引递减
        dizhi_idx = (ming_gong_idx - i + 12) % 12
        palaces[palace_name] = DIZHI[dizhi_idx]
    return palaces
```

---

## 四、身宫寄宫规则

身宫不独立占宫，而是寄附于十二宫之一。身宫只会落在以下六个宫位：

- 命宫
- 夫妻宫
- 财帛宫
- 迁移宫
- 官禄宫
- 福德宫

**身宫寄宫的意义**：表示命主后天最看重、最执着追求的领域。

---

## 参考资源

- [紫微斗数算法的实现流程 - 博客园](https://www.cnblogs.com/voidobject/p/18510346)
- [紫微斗数安星诀与排盘方法详解 - 紫微斗数学堂](http://www.ziweicn.com/show/3083.html)
- [紫微斗数是如何排盘的 - 知乎](https://zhuanlan.zhihu.com/p/678994105)
